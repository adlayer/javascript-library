
(function(a){function f(a){function b(){}return b.prototype=a,new b}function h(a,b,c){var d=document.getElementsByTagName("head")[0]||document.insertBefore(document.firstChild.firstChild,document.createElement("head")),e=document.createElement("script");return e.onload=b||undefined,e.type="text/javascript",e.src=a,d.appendChild(e),e}function x(){var a=e("./jsonp_request").JsonpRequest,b=e("./img_request").ImgRequest;return{jsonp:a.make,get:a.make,img:b.make}}var b={},c={};c.exports={};var d=c.exports,e=function(a){return d};d.copy=f;var g=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a};d.merge=g,d.loadscript=h;var i={},j=function(){var a={load:[],click:[],readyStateChange:[]};this.listeners=function(b){return a[b]},this.addListener=function(b,c){return a[b]||(a[b]=[]),a[b].push(c),a[b]},this.on=function(a,b){return this.addListener(a,b)},this.emit=function(b){var c=a[b];if(c&&c.length>0){var d=0;for(d;d<c.length;d++)c[d].call();return c}}};i.EventEmitter=j,d.events=i;var k={parse:function(a){var b="&",c="=",d={};a=a.split(b);for(var e=0;e<a.length;e++){var f=a[e];f=f.split(c);var g=f[0],h=f[1];isNaN(h)||(h=parseInt(h,10)),d[g]=h}return d},stringify:function(a){var b="&",c="=",d=[];for(var e in a)a[e]&&typeof a[e]!="function"&&d.push(e+c+a[e]);return d.join(b)}};d.querystring=k;var l=function(){var a=e("../utils/merge").merge,b=e("../node_modules/querystring").querystring;this.extend=function(b){return a(this,b)}};d.Core=l;var m=function(a){var b=e("./core").Core;b.apply(this,arguments);var c=new Date;this.type="",this.campaign_id="",this.ad_id="",this.space_id="",this.site_id="",this.page_url="",this.date="",this.time="",this.hour="",this.ip="",this.browser="",this.getFullDate=function(){return typeof c=="object"?(c=c.toISOString(),c):c};var d=function(b){b=b.extend(a)}(this)};m.required=["type","campaign_id","space_id","page_url","page_id"],m.track=function(a){return(new m(a)).save()},m.prototype.getDate=function(){return this.getFullDate().split("T")[0]},m.prototype.getTime=function(){return this.getFullDate().split("T")[1]},m.prototype.getHour=function(){return this.time?this.time.split(":")[0]:!1},m.prototype.validate=function(){for(var a=0;a<m.required.length;a++){var b=m.required[a];if(!this[b])return!1}return!0},m.prototype.toQuery=function(){var a=e("../node_modules/querystring").querystring;return a.stringify(this)},m.prototype.save=function(){throw new Error("You should override this")},d.Event=m;var n=function(a){var b=e("./core").Core,c=e("../node_modules/events").events.EventEmitter;b.apply(this,arguments),c.apply(this,arguments),this.id="",this.name="",this.campaign_id="",this.type="",this.file="",this.link="",this.status=!0,this.alternative={};var d=function(b){b=b.extend(a)}(this)};d.Ad=n;var o=function(){this.getAd=function(a){throw new Error("Implement it")}};d.ISpaceBehaviour=o;var p=function(){this.getAd=function(a){var b=a.ads,c=b.length,d=Math.floor(Math.random()*c),e=b[d];return b.splice(d,1),e}},q=function(a){var b=e("./core").Core;b.apply(this,arguments),this.id="",this.type="",this.status="",this.ads=[],this.behaviour={},this.setBehaviour=function(a){return this.behaviour=a,this.behaviour},this.getAd=function(){return this.behaviour.getAd(this)};var c=function(b){b=b.extend(a),b.setBehaviour(new p)}(this)};d.Space=q;var r=function(a){var b=e("./core").Core;b.apply(this,arguments),this.id="",this.name="",this.spaces=[],this.status=!0;var c=function(b){b=b.extend(a)}(this)};r.prototype.getActiveContent=function(){return this.spaces&&this.spaces.length>=1&&(this.spaces=this.spaces.map(function(a){return a.ads&&a.ads.length>=1&&(a.ads=a.ads.filter(function(a){return a.status})),a})),this},d.Page=r;var s=function(a){var b=e("./core").Core;b.apply(this,arguments),this.id="",this.name="",this.status=!0,this.domains=[];var c=function(b){b=b.extend(a)}(this)};s.prototype.hasDomain=function(a){function d(a,b){return b.indexOf(a)!==-1}var b=this,c=!1;return d(a,this.domains)?c=!0:this.domains.forEach(function(b){var e=d("*",b);e&&(b=b.replace("*",""),d(b,a)&&(c=!0))}),c},d.Site=s;var t=function(){function c(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}var a=e("../domain/core").Core,b=e("../node_modules/querystring").querystring;a.apply(this,arguments),this.host="",this.protocol="http",this.port=80,this.path="",this.qs={},this.query="",this.url="",this.getUrl=function(){return this.url||(this.url=this.protocol,this.url+="://",this.url+=this.host,this.url+=this.path,c(this.qs)||(this.query=[this.query,b.stringify(this.qs)].join("&")),this.query&&(this.url+="?"+this.query)),this.url}};d.Http=t;var u=function(a,b){var c=e("./http").Http;c.apply(this,arguments),this.callback=undefined;var d=function(c){typeof a=="string"?c.url=a:c=c.extend(a),c.callback=b||c.callback}(this)};d.HttpRequest=u;var v=function(){var a=e("./http_request").HttpRequest;a.apply(this,arguments)};v.prototype.send=function(a){a&&(this.qs=a);var b=this.document||b,c=b.createElement("img");return c.src=this.getUrl(),this.callback&&(c.onload=this.callback.apply({ok:!0})),this},v.make=function(a,b,c){var d=new v(a,b);return c&&(d.document=c),d.send(),d},d.ImgRequest=v;var w=function(){var a=e("./http_request").HttpRequest;a.apply(this,arguments)};w.prototype.queryCallback=function(a){return this.qs.callback=a,this},w.prototype.validate=function(){return this.qs.callback!==undefined},w.prototype.send=function(a){function b(a,b){var c=b.createElement("script");return c.type="text/javascript",c.src=a,b.getElementsByTagName("head")[0].appendChild(c),c}return a&&(this.qs=a),b(this.getUrl(),w.document||document),this},w.document=undefined,w.make=function(a,b){function c(a){function b(b){b?a(null,b):a(new Error("No Response"),null)}return b}var d=new w(a,c(b));return d.send(),d},d.JsonpRequest=w,d.request=x;var y=function(a){var b=e("../request/http").Http;b.apply(this,arguments),this._index=0,this.name="",this.requests={};var c=function(b){typeof a=="string"?b.url=a:b=b.extend(a)}(this)};y.prototype.id=function(){return"n"+this._index},y.prototype.newId=function(){return this._index++,this.id()},y.prototype.next=function(a){var b=this.newId();this.requests[b]=a},y.prototype.getCallbackPath=function(){return[this.name,"requests",this.id(),"callback"].join(".")},y.prototype.request=e("../request/request").request,y.prototype.get=function(a,b,c){return typeof b=="function"&&(c=b),b.callback=this.getCallbackPath(),this.path=a,this.qs=b,this.requests[this.id()]={},this.request().get(this,c),this.newId(),this},d.Connection=y,function(){function c(){this.connection={}}var a=e("../utils/copy").copy,b=e("../domain/core").Event;c.prototype.track=function(c){var d=new b(c),e=a(this.connection);e.host=e.host,e.path="/"+d.type+"/"+d.ad_id;if(d.validate()){e.qs=d;var f=x().get(e,function(a,b){console.log(b)});this.connection.next(f)}},d.Tracker=c}();var z=function(){this.id="",this.element=undefined};z.create=function(a,b){return b.createElement(a)},z.prototype.create=function(b,c){return c=this.document||a.document||c,this.element=z.create(b,c),this.element},z.prototype.setAttributes=function(a){var b=e("../utils/merge").merge;b(this.element,a)},z.prototype.append=function(a){return this.element.appendChild(a),this},z.prototype.findParentTag=function(a){var b=this.element.parentNode;while(b.nodeName!=a)b=b.parentNode;return b},z.prototype.addDomEventListener=function(a,b){return typeof addEventListener=="function"?this.element.addEventListener(a,b,!1):typeof attachEvent=="function"?this.element.attachEvent("on"+a,b):this.element["on"+a]=b,this},d.DomElement=z,function(){var a=e("./dom_element").DomElement,b=e("../domain/ad").Ad,c=e("../domain/event").Event,f=function(){b.apply(this,arguments),this.tracker={}};f.prototype=new a,f.prototype.getSpaceId=function(){var a=this.findParentTag("DIV");return a.id},f.prototype.getClickTag=function(a,b,d){var e=this.tracker.connection.getUrl(),f=new c({type:"click",campaign_id:this.campaign_id,space_id:this.getSpaceId(),site_id:a,page_id:b,page_url:d,link:this.link});if(f.validate()&&this.link){var g=[e,"click",this.id].join("/");return g=g+"?"+f.toQuery(),g}return!1},f.prototype.init=function(a,b){var c=this;return c.on("load",function(){c.tracker.track({type:"impression",site_id:b.site_id,domain:b.domain,page_url:b.page_url,page_id:b.page_id,ad_id:c.id,campaign_id:c.campaign_id,space_id:a.id})}),c.on("placement",function(){var a=c.getClickTag(b.site_id,b.page_id,b.page_url);c.element.href=a}),c},d.AdDom=f}(),function(){var a=e("./dom_element").DomElement,b=e("../domain/space").Space,c=function(){b.apply(this,arguments),this.placements={},this.ad={}};c.prototype=new a,c.prototype.placeAd=function(a){return this.element.appendChild(a.element),a.emit("placement"),this.ad=a,this},c.prototype.getElement=function(){return this.document.getElementById(this.id)},d.SpaceDom=c}();var A=function(){var a=e("../node_modules/querystring").querystring;this.align="center",this.menu=!1,this.quality="high",this.scale="noscale",this.wmode="transparent",this.type="application/x-shockwave-flash",this.allowScriptAccess="always",this.allowNetworking="all",this.getSrc=function(){if(!this.preloader)return this.src;var b=this.preloader+"?"+a.stringify({src:this.src,callback:this.callback,value:this.id});return b}};d.Swf=A,function(){var a=e("../dom/ad_dom").AdDom,b=e("./swf").Swf,c=function(){a.apply(this,arguments),b.apply(this,arguments);var c=function(a){return a.create("EMBED"),a.element.src=a.getSrc(),a.element.setAttribute("height",a.height),a.element.setAttribute("width",a.width),a.element.setAttribute("type",a.type),a.element.setAttribute("allowScriptAccess",a.allowScriptAccess),a.element.setAttribute("allowNetworking",a.allowNetworking),a.element.setAttribute("menu",a.menu),a.element.setAttribute("wmode",a.wmode),a.element.setAttribute("scale",a.scale),a.element.setAttribute("quality",a.quality),a.element.id=a.id,a.element}(this)};c.prototype=new a,d.EmbedAd=c}(),function(){var a=e("../dom/ad_dom").AdDom,b=e("./swf").Swf,c=function(){var c=this;a.apply(this,arguments),b.apply(this,arguments);var d="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",e="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0",f="http://www.macromedia.com/go/getflashplayer",g=function(a,b){return this.name=a,this.value=b,this.element=c.create("param"),this.element.setAttribute("name",this.name),this.element.setAttribute("value",this.value),this.element},h=function(a){a.create("OBJECT"),a.element.src=a.src,a.element.setAttribute("data",a.src),a.element.setAttribute("classid",d),a.element.setAttribute("codebase",e);var b=a.element.cloneNode(!0);return b.appendChild(new g("movie",a.getSrc())),b.appendChild(new g("quality",a.quality)),b.appendChild(new g("src",a.src)),b.appendChild(new g("menu",a.menu)),b.appendChild(new g("scale",a.scale)),b.appendChild(new g("allowScriptAccess",a.allowScriptAccess)),b.appendChild(new g("allowNetworking","all")),b.appendChild(new g("base",a.base)),b.appendChild(new g("wmode",a.wmode)),a.element=b,a.element.id=a.id,a.element}(this)};c.prototype=new a,d.ObjectAd=c}(),function(){var a=e("../dom/ad_dom").AdDom,b=function(){a.apply(this,arguments);var b=function(a){a.create("img"),a.element.setAttribute("height",a.height),a.element.setAttribute("width",a.width),a.element.src=a.src;var b=a.element;return a.element.id=a.id,a.addDomEventListener("load",function(){a.emit("load")}),a.link&&(a.create("a"),a.element.href=a.link,a.append(b)),a.element}(this)};b.prototype=new a,d.ImgAd=b}(),function(){var a=e("./embed_ad.js").EmbedAd,b=e("./object_ad.js").ObjectAd,c=function(c){var d=function(d){return d.browser?new b(c):new a(c)}(this);return d};d.FlashAd=c}(),function(){d.ads=function(){var a=e("./flash_ad.js").EmbedAd,b=e("./img_ad.js").ImgAd;return{create:function(c){c.id=c._id,c.src=c.file,delete c.file,delete c._id;switch(c.type){case"flash":return c.preloader="http://xframe.adlayerjavascriptsdk.com.s3.amazonaws.com/as3.swf",c.callback="adlayer.markAdAsLoaded",new a(c);case"image":return new b(c)}}}}()}(),function(){var a=e("../dom/space_dom").SpaceDom,b=e("../ads/ads").ads,c=function(){a.apply(this,arguments),this.placements={},this.ad={}};c.prototype=new a,c.prototype.init=function(a,c){if(this.ads&&this.ads.length>0){var d=b.create(this.getAd());d.tracker=a,d=d.init(this,c),this.placeAd(d)}return this},d.BasicSpace=c}(),function(){var a=e("./basic_space").BasicSpace,b=function(){a.apply(this,arguments),this.expandEvent="mouseover",this.retreatEvent="mouseout";var b=function(a){a.element=a.element||a.getElement()||a.create("DIV"),a.element.id=a.id,a.element.style.height=a.height,a.element.style.width=a.width,a.element.style.position="absolute",a.addDomEventListener(a.expandEvent,function(){a.expand(),a.state="expanded"}),a.addDomEventListener(a.retreatEvent,function(){a.retract(),a.state="retreated"}),a.retract()}(this)};b.prototype=new a,b.prototype.clip=function(a,b){return this.element.style.clip="rect(0px "+a+" "+b+" 0px)",this},b.prototype.expand=function(){var a=this.element.firstChild;if(a)return this.clip(a.width+"px",a.height+"px"),this},b.prototype.retract=function(){return this.clip(this.width,this.height),this},d.ExpandableSpace=b}(),function(){var a=e("./basic_space").BasicSpace,b=function(){a.apply(this,arguments),this.close=function(){var a=this.element;a.parentNode.removeChild(a),delete this.element};var b=function(a){a.element=a.element||a.getElement()||a.create("DIV"),a.element.id=a.id,a.element.style.height=a.height,a.element.style.width=a.width,a.element.style.position="absolute";var b=a.document.createElement("BUTTON");b.innerHTML="x",b.onclick=function(){a.close()},a.append(b)}(this)};b.prototype=new a,d.FloaterSpace=b}(),function(){var a=e("./basic_space").BasicSpace,b=function(){a.apply(this,arguments);var b=function(a){a.element=a.element||a.getElement()||a.create("DIV"),a.element.style.height=a.height,a.element.style.width=a.width,a.element.id=a.id}(this)};b.prototype=new a,d.StaticSpace=b}(),function(){d.spaces=function(){var a=e("./expandable_space.js").ExpandableSpace,b=e("./floater_space.js").FloaterSpace,c=e("./static_space.js").StaticSpace;return{create:function(d){d.id=d._id,d.width=d.size.width,d.height=d.size.height,delete d._id,delete d.size;switch(d.type){case"expandable":return new a(d);case"floater":return new b(d);case"static":return new c(d)}}}}()}(),d.config={url:{adserver:{host:"jocasta.adlayerapp.com"},tracker:{host:"tracker.adlayerapp.com"}},adsPerSpace:1,page:{autoRun:!0,scriptTagId:"adlayerScript"}},function(){var a=e("../node_modules/events").events.EventEmitter,b=e("../domain/page").Page,c=e("../request/request").request,g=e("../spaces/spaces").spaces,h=function(){b.apply(this,arguments),a.apply(this,arguments),this.document,this.tracker,this.connection,this.spacesCollection={},this.adsCollection={}};h.prototype.getData=function(a){var b=this.connection.id(),d=f(this.connection);d.host=d.host,d.path="/pages/"+this.id,d.qs={callback:"adlayer.connections.adserver.requests."+b+".callback",domain:this.domain,site_id:this.site_id,ads_per_space:this.adsPerSpace};var e=c().get(d,a);this.connection.requests[b]=e},h.prototype.scanSpaces=function(a,b){for(var c=0;c<a.length;c++){var d=a[c];d.document=this.document,d=g.create(a[c]),d.element=d.getElement();if(d.element)b(null,d);else{var e={error:"not found",id:d._id};b(e,null)}}},h.prototype.renderSpace=function(a,b){var c=a.init(this.tracker,b);c.ad&&(this.adsCollection[c.ad.id]=c.ad)},h.prototype.init=function(){var a=this;return this.getData(function(b,c){c&&c.spaces&&a.scanSpaces(c.spaces,function(b,c){if(!b){var d={domain:a.domain,page_url:a.url,page_id:a.id,site_id:a.site_id};a.renderSpace(c,d),a.spacesCollection[c.id]=c}})}),a},d.PageApi=h}(),function(a){var b=e("../node_modules/querystring").querystring,c=e("../connection/connection").Connection,d=e("./page").PageApi,f=e("../tracker/tracker").Tracker,g=e("../config/config").config,h=h||a,i=h.adlayer||{},j=i.config||{};j.url=j.url||g.url,j.adsPerSpace=j.adsPerSpace||g.adsPerSpace,j.page=j.page||g.page,i.config=j;var k={adserver:new c(j.url.adserver),tracker:new c(j.url.tracker)},l=new f;l.connection=k.tracker,i.page={},i.config=j,i.connections=k,i.spaces={},i.ads={},i.markAdAsLoaded=function(a){i.ads[a].emit("load")},function(){var c=h.document;if(j.page.autoRun&&c){var e=c.getElementById(j.page.scriptTagId),f=e.src.split("?")[1],g=b.parse(f);j.site_id=j.site_id||g.site,j.domain=j.domain||h.location.hostname,j.page_id=j.page_id||g.page,j.page_url=j.page_url||h.location.href;var m=new d({tracker:l,id:j.page_id,url:j.page_url,site_id:j.site_id,domain:j.domain,connection:k.adserver,document:c,adsPerSpace:j.adsPerSpace});i.page=m.init(),i.spaces=m.spacesCollection,i.ads=m.adsCollection}}()}(this)})(this)