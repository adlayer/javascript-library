
(function(){function c(){this.connection={}}var a=require("../utils/copy").copy,b=require("../domain/core").Event;c.prototype.track=function(c){var d=new b(c),e=a(this.connection);e.host=e.host,e.path="/"+d.type+"/"+d.ad_id;if(d.validate()){e.qs=d;var f=request().get(e,function(a,b){console.log(b)});this.connection.next(f)}},exports.Tracker=c})(),function(){var a=require("../node_modules/events").events.EventEmitter,b=require("../domain/page").Page,c=require("../request/request").request,d=require("../spaces/spaces").spaces,e=function(){b.apply(this,arguments),a.apply(this,arguments),this.document,this.tracker,this.connection};e.prototype.getData=function(a){var b=this.connection.id(),d=copy(this.connection);d.host=d.host,d.path="/pages/"+this.id,d.qs={callback:"adlayer.connections.adserver.requests."+b+".callback",domain:this.domain,site_id:this.site_id};var e=c().get(d,a);this.connection.requests[b]=e},e.prototype.scanSpaces=function(a,b){for(var c=0;c<a.length;c++){var e=a[c];e.document=this.document,e=d.create(a[c]),e.element=e.getElement();if(e.element)b(null,e);else{var f={error:"not found",id:e._id};b(f,null)}}},exports.PageApi=e}(),function(a){function p(a,b){return o[b.id]=b,b.tracker=l,b.on("load",function(){b.tracker.track({type:"impression",site_id:j.site_id,domain:j.domain,page_url:j.page_url,page_id:j.page_id,ad_id:b.id,campaign_id:b.campaign_id,space_id:a.id})}),b.on("placement",function(){var a=b.getClickTag(j.site_id,j.page_id,j.page_url);b.element.href=a}),b}function q(a){n[a.id]=a;var b=h.create(a.getAd());b=p(a,b),a.placeAd(b)}var b=require("../node_modules/querystring").querystring,c=require("../utils/copy").copy,d=require("../connection/connection").Connection,e=require("./page").PageApi,f=require("./tracker").Tracker,g=require("../config/config").config,h=require("../ads/ads").ads;a.adlayer=a.adlayer||{};var i=a.adlayer,j=i.config||g,k={adserver:new d(j.url.adserver),tracker:new d(j.url.tracker)},l=new f;l.connection=k.tracker;var m={},n={},o={};e.init=function(){var b=new e({id:j.page_id,site_id:j.site_id,domain:j.domain,connection:k.adserver,document:a.document});return b.getData(function(a,c){c&&c.spaces&&b.scanSpaces(c.spaces,function(a,b){a||q(b)})}),b},function(){var d=a.document.getElementById(j.page.scriptTagId),f=d.src.split("?")[1],g=b.parse(f);j.site_id=j.site_id||g.site,j.domain=j.domain||a.location.hostname,j.page_id=j.page_id||g.page,j.page_url=j.page_url||a.location.href,j.page.autoRun&&(m=e.init())}(),i.page=m,i.config=j,i.connections=k,i.spaces=n,i.ads=o}(this)